name: Docker CI (Selective Build & Trivy Scan)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAMESPACE: tienphatng237
  IMAGE_TAG: v1

jobs:
  # =====================================================
  # Detect which microservices have changed
  # =====================================================
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      service_registry: ${{ steps.filter.outputs.service_registry }}
      api_gateway: ${{ steps.filter.outputs.api_gateway }}
      user_service: ${{ steps.filter.outputs.user_service }}
      account_service: ${{ steps.filter.outputs.account_service }}
      transaction_service: ${{ steps.filter.outputs.transaction_service }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Detect changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            service_registry:
              - 'Service-Registry/**'
            api_gateway:
              - 'API-Gateway/**'
            user_service:
              - 'User-Service/**'
            account_service:
              - 'Account-Service/**'
            transaction_service:
              - 'Transaction-Service/**'

  # =====================================================
  # SERVICE REGISTRY
  # =====================================================
  service-registry:
    name: Build & Push service-registry
    needs: detect-changes
    if: needs.detect-changes.outputs.service_registry == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build service-registry
        run: |
          docker build \
            -t $IMAGE_NAMESPACE/service-registry:$IMAGE_TAG \
            ./Service-Registry

      - name: Trivy scan service-registry
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: tienphatng237/service-registry:v1
          severity: HIGH,CRITICAL
          exit-code: 1

      - name: Push service-registry
        run: docker push $IMAGE_NAMESPACE/service-registry:$IMAGE_TAG

  # =====================================================
  # API GATEWAY
  # =====================================================
  api-gateway:
    name: Build & Push api-gateway
    needs: detect-changes
    if: needs.detect-changes.outputs.api_gateway == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build api-gateway
        run: |
          docker build \
            -t $IMAGE_NAMESPACE/api-gateway:$IMAGE_TAG \
            ./API-Gateway

      - name: Trivy scan api-gateway
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: tienphatng237/api-gateway:v1
          severity: HIGH,CRITICAL
          exit-code: 1

      - name: Push api-gateway
        run: docker push $IMAGE_NAMESPACE/api-gateway:$IMAGE_TAG

  # =====================================================
  # USER SERVICE
  # =====================================================
  user-service:
    name: Build & Push user-service
    needs: detect-changes
    if: needs.detect-changes.outputs.user_service == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build user-service
        run: |
          docker build \
            -t $IMAGE_NAMESPACE/user-service:$IMAGE_TAG \
            ./User-Service

      - name: Trivy scan user-service
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: tienphatng237/user-service:v1
          severity: HIGH,CRITICAL
          exit-code: 1

      - name: Push user-service
        run: docker push $IMAGE_NAMESPACE/user-service:$IMAGE_TAG

  # =====================================================
  # ACCOUNT SERVICE
  # =====================================================
  account-service:
    name: Build & Push account-service
    needs: detect-changes
    if: needs.detect-changes.outputs.account_service == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build account-service
        run: |
          docker build \
            -t $IMAGE_NAMESPACE/account-service:$IMAGE_TAG \
            ./Account-Service

      - name: Trivy scan account-service
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: tienphatng237/account-service:v1
          severity: HIGH,CRITICAL
          exit-code: 1

      - name: Push account-service
        run: docker push $IMAGE_NAMESPACE/account-service:$IMAGE_TAG

  # =====================================================
  # TRANSACTION SERVICE
  # =====================================================
  transaction-service:
    name: Build & Push transaction-service
    needs: detect-changes
    if: needs.detect-changes.outputs.transaction_service == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build transaction-service
        run: |
          docker build \
            -t $IMAGE_NAMESPACE/transaction-service:$IMAGE_TAG \
            ./Transaction-Service

      - name: Trivy scan transaction-service
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: tienphatng237/transaction-service:v1
          severity: HIGH,CRITICAL
          exit-code: 1

      - name: Push transaction-service
        run: docker push $IMAGE_NAMESPACE/transaction-service:$IMAGE_TAG
