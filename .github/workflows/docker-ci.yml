name: Docker CI (Selective Build & Trivy Scan)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_NAMESPACE: tienphatng237
  IMAGE_TAG: v1

jobs:
# =====================================================
# Detect changed microservices
# =====================================================
  detect-changes:
    name: Detect changed services
    runs-on: ubuntu-latest
    outputs:
      service_registry: ${{ steps.filter.outputs.service_registry }}
      api_gateway: ${{ steps.filter.outputs.api_gateway }}
      user_service: ${{ steps.filter.outputs.user_service }}
      account_service: ${{ steps.filter.outputs.account_service }}
      transaction_service: ${{ steps.filter.outputs.transaction_service }}

    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            service_registry:
              - 'Service-Registry/**'
            api_gateway:
              - 'API-Gateway/**'
            user_service:
              - 'User-Service/**'
            account_service:
              - 'Account-Service/**'
            transaction_service:
              - 'Transaction-Service/**'

# =====================================================
# TEMPLATE FOR MICROSERVICE JOBS
# =====================================================
  service-registry:
    name: Build & Push service-registry
    needs: detect-changes
    if: needs.detect-changes.outputs.service_registry == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build image
        run: docker build -t $IMAGE_NAMESPACE/service-registry:$IMAGE_TAG ./Service-Registry

      - name: Trivy scan (DEV mode)
        uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_NAMESPACE }}/service-registry:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          exit-code: 0

      - name: Push image
        run: docker push $IMAGE_NAMESPACE/service-registry:$IMAGE_TAG

# =====================================================
  api-gateway:
    name: Build & Push api-gateway
    needs: detect-changes
    if: needs.detect-changes.outputs.api_gateway == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker build -t $IMAGE_NAMESPACE/api-gateway:$IMAGE_TAG ./API-Gateway

      - uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_NAMESPACE }}/api-gateway:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          exit-code: 0

      - run: docker push $IMAGE_NAMESPACE/api-gateway:$IMAGE_TAG

# =====================================================
  user-service:
    name: Build & Push user-service
    needs: detect-changes
    if: needs.detect-changes.outputs.user_service == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker build -t $IMAGE_NAMESPACE/user-service:$IMAGE_TAG ./User-Service

      - uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_NAMESPACE }}/user-service:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          exit-code: 0

      - run: docker push $IMAGE_NAMESPACE/user-service:$IMAGE_TAG

# =====================================================
  account-service:
    name: Build & Push account-service
    needs: detect-changes
    if: needs.detect-changes.outputs.account_service == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker build -t $IMAGE_NAMESPACE/account-service:$IMAGE_TAG ./Account-Service

      - uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_NAMESPACE }}/account-service:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          exit-code: 0

      - run: docker push $IMAGE_NAMESPACE/account-service:$IMAGE_TAG

# =====================================================
  transaction-service:
    name: Build & Push transaction-service
    needs: detect-changes
    if: needs.detect-changes.outputs.transaction_service == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - run: docker build -t $IMAGE_NAMESPACE/transaction-service:$IMAGE_TAG ./Transaction-Service

      - uses: aquasecurity/trivy-action@0.20.0
        with:
          image-ref: ${{ env.IMAGE_NAMESPACE }}/transaction-service:${{ env.IMAGE_TAG }}
          severity: HIGH,CRITICAL
          exit-code: 0

      - run: docker push $IMAGE_NAMESPACE/transaction-service:$IMAGE_TAG
